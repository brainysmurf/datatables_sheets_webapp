<script>

function returnData() {

	return [];
}

$(function () {
	// Document DOM is ready:

	// Make the tabs
	$('#tabs').tabs();

	google.script.run

      .withSuccessHandler(function (rawData) {
          $('<tfoot/>').appendTo(rawData.selector);

          var template = $.parseHTML(rawData.template || ""),
              $template = $(template),
              columns = template ? 
                $template.find('div').toArray().reduce(function (acc, div) {
                  var $div = $(div);
                  var mapped = $div.data();
                  mapped.title = $div.data('title') || $div.attr('id');
                  mapped.data = $div.attr('id');
                  acc.push(mapped);
                  return acc;
                }, [])
              :
                rawData.columns.reduce(function (acc, col) {
                  mapped.data = col;
                  acc.push({
                    title: col, data:col,
                    stringFilter: false, categoryFilter: false
                  });
                  return acc;
                }, []);

          var hasSideFilters = $template.find('div').toArray().some(function (div) {
            var $div = $(div);
            return ($div.data('f-placement') == 'top' && $div.attr('id'))|| false;
          });

          // Makes the datatable
          var settings = $.extend({}, $template.data());  // copy
          settings.columns = columns;

          if (hasSideFilters) {
            // 
            // Add extra html to account for the sidebar required for filters on the side
            //
            $('#theDatatable').wrap( $('<div/>', {
              id: 'displayTable', 
              class: 'displayCell'
            }));
            $('#displayTable').wrap( $('<div/>', {
              id: 'displayContainer',
            }));
            $('#displayContainer').prepend( $('<div/>', {
              id: 'displayFilters', 
              class: 'displayCell',
            }));
          }

          settings.initComplete = function () {
            this.api().columns().every( function () {
                var column = this,
                    title = column.dataSrc(),
                    $div = $template.find('#'+title);

                if ($div.data('f-type') == 'select') {
                  var $select = $('<select><option value=""></option></select>')
                      .addClass('filterType')
                      .insertBefore( $(column.footer()) )
                      .on( 'change', function () {
                          var val = $.fn.dataTable.util.escapeRegex($(this).val());     
                          var newValue  = val ? '^'+val+'$' : '';
                          console.log(newValue);
                          column
                              .search( newValue, true, false )
                              .draw();
                      } );

                  column.data().unique().sort().each( function ( d, j ) {
                      var $d = $(d);
                      $select.append( '<option value="'+$d[0].outerHTML+'">'+$d.text()+'</option>' );
                  } );
                }

                if ($div.data('f-type') == 'input') {
                  var $input = $('<input placeholder="' + ($div.data('f-label') || 'Search...') + '"/>')
                      .addClass('filterType')
                      .appendTo( $(column.footer()).empty() )
                      .on( 'keyup change', function () {
                          var val = $.fn.dataTable.util.escapeRegex(
                              $(this).val()
                          );
   
                          var newValue  = val || '';
                          console.log(newValue);
                          column
                              .search( newValue, true, false )
                              .draw();
                      } );

                }
            } );
            console.log('initcomplete complete');
          };
      

          var templateCache = columns.reduce(function (acc, col) {
            acc[col.data] = $template.find('#'+ col.data).html() || "{{self}}";
            return acc;
          }, {});

          var rowsToBeAdded = rawData.rows.reduce(function (acc, row) {
              var valueObj = columns.reduce(function (a, col, index) {
                a[col.data] = row[index];
                return a;
              }, {});
              var result = columns.reduce(function (a, col) {
                var before = $.trim(templateCache[col.data]);  // remove whitespace to preserve search
                var combined = Object.assign(valueObj, {self: valueObj[col.data]});
                var after = Handlebars.compile(before)( combined );
                a[col.data] = after;
                return a;
              }, {});
              acc.push(result);
              return acc;
          }, []);

          settings.data = rowsToBeAdded;
          $DT = $(rawData.selector)
            .addClass($template.data('add-class'))
            .DataTable(settings);
       })

      .withFailureHandler(function (error) {
          console.log(error);
      })

	.returnData();  // interact with document with Google API calls


});

</script>