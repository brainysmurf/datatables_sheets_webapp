<script>

function camelize_(str) {
  return str.replace(/(?:^\w|[A-Z]|\b\w)/g, function(letter, index) {
    return index == 0 ? letter.toLowerCase() : letter.toUpperCase();
  }).replace(/\s+/g, '');
}

function mapDiv($div, col, c) {
  if ($div.length == 0) $div = $('<div/>');
  var mapped = $div.data() || {};
  mapped.title = $div.data('title') || $div.attr('id') || col;
  mapped.data = $div.attr('id') || c;
  if (!mapped.hasOwnProperty('title')) {
    mapped.title = $div.attr('id');
  }
  if (!mapped.hasOwnProperty('visible')) {
    mapped.visible = false;
  }
  if (mapped.fType) {
    mapped.sortable = false;
  }
  return mapped;           
}

$(function () {
	// Document DOM is ready:

  var $dt = $('#theDatatable');

	google.script.run

      .withSuccessHandler(function (rawData) {
          var template = $.parseHTML(rawData.template || ""),
              $template = $(template),
              columns;

              if (template) {
                columns = rawData.columns.reduce(
                  function (acc, col) {
                    var c = camelize_(col);
                    var $div = $template.find('#'+c);
                    acc.push(mapDiv($div, col, c));
                    return acc;
                  }, []);
                var selectHelper = '#' + rawData.columns.reduce(function (a, c) {
                  a.push(camelize_(c));
                  return a;
                }, []).join(",#");
                $template.find('div:not(' + selectHelper + ')').each(function (i, div) {
                  var $div = $(div);
                  if ($div.attr('id')) {
                    columns.push(
                      mapDiv( $div, $div.prop('title') || $div.prop('id'), $div.prop('id') )
                    );
                  }
                });
              }
              else {
                columns = rawData.columns.reduce(function (acc, col) {
                  var c = camelize_(col);
                  mapped.data = c;
                  acc.push({
                    title: col, data: c,
                    stringFilter: false, categoryFilter: false
                  });
                  return acc;
                }, []);
              }

          var hasSideFilters = $template.find('div').toArray().some(function (div) {
            var $div = $(div);
            return ($div.data('f-placement') == 'left' && $div.attr('id'))|| false;
          });

          // Makes the datatable
          var settings = $.extend({}, $template.data());  // copy
          settings.columns = columns;

          if (hasSideFilters) {
            // 
            // Add extra html to account for the sidebar required for filters on the side
            //
            $('#theDatatable').wrap( $('<div/>', {
              id: 'displayTable', 
              class: 'displayCell'
            }));
            $('#displayTable').wrap( $('<div/>', {
              id: 'displayContainer',
            }).css({
              display: 'table',
              width: '100%'
            }));
            $('#displayContainer').prepend( $('<div/>', {
              id: 'displayFilters', 
            }).css({
              'min-width': '200px',
              'display': 'table-cell'
            }));
          }

          settings.initComplete = function () {
            this.api().columns().every( function () {
                var column = this,
                    title = column.dataSrc(),
                    $div = $template.find('#'+title);

                if ($div.data('f-type') == 'select') {
                  var header = $div.data('f-label') || $div.data('title') || title;
                  var $select = $('<select><option value="">' + header + '</option></select>')
                      .appendTo( 
                        $div.data('f-placement') == 'left'
                        ? 
                        $('#displayFilters')
                        :
                        $(column.header()).empty() 
                      )
                      .css('width', '90%')
                      .on( 'change', function () {
                          var val = $(this).val();  // $.fn.dataTable.util.escapeRegex( $(this).val() );
                          var newValue  = val; // ? '^'+val+'$' : '';
                          column
                              .search( newValue, true, false, true )
                              .draw();
                      } );

                  column.data().unique().sort().each( function ( d, j ) {
                      try {
                        var $d = $(d);
                      } catch (e) {
                        // jquery might produce a syntax error, so force it to use plaintext
                        $d = [];
                      }
                      if ($d.length == 1) {
                        // Apparently passing the html ($d[0].outerHTML) is incorrect,
                        // but inspecting column.data() reveals the html is there, not sure why...
                        $select.append( '<option value="'+$d.text()+'">'+$d.text()+'</option>' );
                      } else {
                        $select.append( '<option value="'+d+'">'+d+'</option>' );
                      }
                  } );
                }

                if ($div.data('f-type') == 'input') {
                  var header = $div.data('f-label') || $div.data('title');
                  var $input = $('<input placeholder="' + header + '"/>')
                      .appendTo( $(column.header()).empty() )
                      .on( 'keyup change', function () {
                          var val = $.fn.dataTable.util.escapeRegex( $(this).val() );   
                          var newValue  = val || '';
                          column
                              .search( newValue, true, false, true )
                              .draw();
                      } );

                }
            } );
          };

          var templateCache = columns.reduce(function (acc, col) {
            acc[col.data] = $.trim($template.find('#'+ col.data).html()) || "{{self}}";
            return acc;
          }, {});

          var rowsToBeAdded = rawData.rows.reduce(function (acc, row) {
              var valueObj = columns.reduce(function (a, col, index) {
                a[col.data] = row[index];
                return a;
              }, {});
              var result = columns.reduce(function (a, col) {
                var before = templateCache[col.data];
                var combined = Object.assign(valueObj, {self: valueObj[col.data]});
                var after = Handlebars.compile(before)( combined );
                a[col.data] = after;
                return a;
              }, {});
              acc.push(result);
              return acc;
          }, []);

          settings.data = rowsToBeAdded;
          $DT = $(rawData.selector).DataTable(settings);
       })

      .withFailureHandler(function (error) {
          console.log(error);
      })

	.returnData($dt.data('source'), $dt.data('range'));  // interact with document with Google API calls


});

</script>